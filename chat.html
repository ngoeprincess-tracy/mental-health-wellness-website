<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Support Chat — MINDWELL</title>
  <style>
    :root{--bg:#f3fff7;--card:#fff;--accent:#2f9e44;--accent-600:#227a35;--muted:#3f6b56}
    body{font-family:Inter,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#0b2136}
    .container{max-width:820px;margin:28px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center}
    .chat-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(13,38,76,0.06)}
    #chatWindow{height:420px;overflow:auto;border-radius:10px;border:1px solid #eef6ee;padding:12px;background:#f9fff7}
    .msg{display:flex;gap:8px;margin-bottom:10px;align-items:flex-end}
    .msg.bot{justify-content:flex-start}
    .msg.user{justify-content:flex-end}
    .bubble{max-width:75%;padding:10px 12px;border-radius:12px;font-size:0.95rem;line-height:1.3}
    .bubble.bot{background:#ffffff;border:1px solid #e6f7ea;color:#072b15}
    .bubble.user{background:var(--accent);color:#fff;text-align:right}
    .controls{display:flex;gap:8px;margin-top:10px}
    input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #e6f0eb}
    button{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #dbeee0;color:var(--accent)}
    .small{font-size:0.9rem;color:var(--muted)}
    .quick{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .quick button{background:transparent;border:1px solid #dbeee0;color:var(--accent);padding:6px 8px;border-radius:999px;cursor:pointer}
    footer{margin-top:14px;color:var(--muted);font-size:0.9rem;text-align:center}

    /* Crisis support footer */
    .crisis-footer{position:fixed;left:16px;right:16px;bottom:16px;background:linear-gradient(90deg,#f0fff4,#e6fff0);border:1px solid #b7f3c7;color:var(--accent-600);padding:12px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(15,80,40,0.06);display:flex;gap:12px;align-items:center;z-index:9999;font-size:0.95rem}
    .crisis-footer a{ color:var(--accent-600); font-weight:600; text-decoration:underline; }
    .crisis-close{ margin-left:auto; background:transparent; border:0; font-size:18px; line-height:1; cursor:pointer; color:var(--accent-600); }
    @media (max-width:520px){ .crisis-footer{left:10px;right:10px;bottom:10px;font-size:0.9rem} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <a href="index.html" style="text-decoration:none;color:inherit"><strong>MINDWELL</strong></a>
        <div class="small">Supportive automated chat — not a replacement for professional help.</div>
      </div>
      <nav aria-label="Primary">
        <a class="small" href="dashboard.html">Dashboard</a> |
        <a class="small" href="exercises.html">Exercises</a> |
        <a class="small" href="articles.html">Articles</a>
      </nav>
    </header>

    <main class="chat-card" aria-live="polite">
      <div id="chatWindow" aria-live="polite" role="log"></div>

      <div class="quick" id="quickReplies">
        <button data-text="I'm anxious">I'm anxious</button>
        <button data-text="I feel stressed">I feel stressed</button>
        <button data-text="Feeling low">Feeling low</button>
        <button data-text="Need breathing exercise">Breathing</button>
      </div>

      <div class="controls" role="group" aria-label="Message input">
        <input id="input" type="text" placeholder="Write a message..." aria-label="Message input" />
        <button id="btnSend">Send</button>
        <button id="btnClear" class="ghost">Clear</button>
      </div>

      <footer>Messages are stored locally on this device only.</footer>
    </main>
  </div>

  <!-- Crisis support footer -->
  <div class="crisis-footer" role="contentinfo" aria-live="polite">
    <div>
      If you are in immediate danger or thinking about harming yourself, call local emergency services now. In Cameroon dial <strong>119</strong>.
    </div>
    <button id="crisisClose" class="crisis-close" aria-label="Dismiss crisis support">✕</button>
  </div>

  <script src="motiv.js" defer></script>
  <script>
    const STORAGE_KEY = 'mh_chat_msgs_v1';
    const chatWindow = document.getElementById('chatWindow');
    const input = document.getElementById('input');
    const btnSend = document.getElementById('btnSend');
    const btnClear = document.getElementById('btnClear');
    const quick = document.getElementById('quickReplies');

    function loadMessages(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; }
    }
    function saveMessages(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function renderMessage(m){
      const el = document.createElement('div');
      el.className = 'msg ' + (m.from === 'bot' ? 'bot' : 'user');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (m.from === 'bot' ? 'bot' : 'user');
      bubble.innerHTML = m.text;
      el.appendChild(bubble);
      chatWindow.appendChild(el);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendAndStore(msg){
      const arr = loadMessages();
      arr.push(msg);
      saveMessages(arr);
      renderMessage(msg);
    }

    function generateResponse(text){
      const t = (text || '').toLowerCase();
      // crisis keywords
      const crisis = ['suicide','kill myself','end my life','want to die','hurt myself','die','self-harm'];
      if (crisis.some(k => t.includes(k))){
        return {
          text: "I'm sorry you're feeling this way. If you are in immediate danger call emergency services now. In Cameroon dial 119. Would you like resources or someone to contact?",
          urgent: true
        };
      }
      // simple rule-based replies
      if (t.includes('anx') || t.includes('nerv')) return { text: "Take a slow breath with me: inhale for 4, hold 4, exhale 4. Want me to guide you through a 1‑minute breathing?" };
      if (t.includes('stress')) return { text: "Small steps can help — try naming 3 things you can see right now, and take a deep breath." };
      if (t.includes('sleep')) return { text: "Try winding down with 10 minutes of quiet breathing and dim lights. Would you like a short relaxation exercise?" };
      if (t.includes('breath') || t.includes('breathing')) return { text: "Starting breathing exercise: inhale — hold — exhale. I'll count: Inhale... 1,2,3,4." };
      if (t.includes('hi') || t.includes('hello') || t.includes('hey')) return { text: "Hi — I'm here to listen. How are you feeling right now?" };
      if (!t.trim()) return { text: "Type a message or choose a quick reply. I'm here." };
      // fallback supportive reply
      return { text: "Thanks for sharing. Tell me more, or choose 'Breathing' to try a short exercise." };
    }

    function botReplyFor(text){
      const res = generateResponse(text);
      const botMsg = { from:'bot', text: res.text, ts: Date.now() };
      appendAndStore(botMsg);
      if (res.urgent){
        // show crisis footer more prominently
        const el = document.querySelector('.crisis-footer');
        if (el) el.style.display = '';
      }
      // opportunistic speech
      try { if (window.speechSynthesis && res) { const u = new SpeechSynthesisUtterance(res.text); window.speechSynthesis.cancel(); u.rate = 1; window.speechSynthesis.speak(u); } } catch(e){}
    }

    function sendUserMessage(text){
      const trimmed = (text || '').trim();
      if (!trimmed) return;
      const userMsg = { from:'user', text: trimmed, ts: Date.now() };
      appendAndStore(userMsg);
      input.value = '';
      setTimeout(() => botReplyFor(trimmed), 600);
    }

    // wire controls
    btnSend.addEventListener('click', () => sendUserMessage(input.value));
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendUserMessage(input.value); });
    quick.addEventListener('click', (e) => {
      const b = e.target.closest('button');
      if (!b) return;
      const t = b.dataset.text || b.textContent;
      sendUserMessage(t);
    });

    btnClear.addEventListener('click', () => {
      if (!confirm('Clear conversation?')) return;
      localStorage.removeItem(STORAGE_KEY);
      chatWindow.innerHTML = '';
      // starter greeting
      appendAndStore({from:'bot', text:"Hi — I'm here to listen. How are you feeling right now?", ts:Date.now()});
    });

    // initial render
    (function init(){
      const msgs = loadMessages();
      if (msgs && msgs.length) msgs.forEach(renderMessage);
      else {
        const greet = {from:'bot', text: "Hi — I'm here to listen. How are you feeling right now?", ts: Date.now()};
        appendAndStore(greet);
      }
    })();

    // Crisis footer behavior
    (function(){
      const KEY = 'mh_crisis_hidden_until';
      const el = document.querySelector('.crisis-footer');
      if (!el) return;
      const close = document.getElementById('crisisClose');
      const hiddenUntil = Number(localStorage.getItem(KEY) || 0);
      if (hiddenUntil > Date.now()) { el.style.display = 'none'; }
      close.addEventListener('click', () => {
        el.style.display = 'none';
        localStorage.setItem(KEY, String(Date.now() + 24*60*60*1000));
      });
    })();

    // stop speech on unload
    window.addEventListener('beforeunload', () => { try{ window.speechSynthesis.cancel(); }catch(e){} });
  </script>
</body>
</html>