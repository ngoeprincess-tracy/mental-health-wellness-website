<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — MINDWELL</title>
  <style>
    :root{--bg:#f3fff7;--card:#fff;--accent:#2f9e44;--accent-600:#227a35;--muted:#3f6b56}
    body{font-family:Inter,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#0b2136}
    .wrap{max-width:880px;margin:28px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:1.1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(13,38,76,0.06)}
    label{display:block;margin-top:8px;font-size:0.95rem}
    input[type="email"],input[type="password"],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6f0eb;margin-top:6px}
    button{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #dbeee0;color:var(--accent)}
    .muted{color:var(--muted);font-size:0.95rem}
    .msg{margin-top:8px;color:#b22}
    .ok{margin-top:8px;color:green}
    .actions{display:flex;gap:8px;margin-top:12px}
    .small{font-size:0.9rem;color:var(--muted)}
    footer{margin-top:16px;color:var(--muted);font-size:0.9rem;text-align:center}

    /* Crisis support footer */
    .crisis-footer{position:fixed;left:16px;right:16px;bottom:16px;background:linear-gradient(90deg,#f0fff4,#e6fff0);border:1px solid #b7f3c7;color:var(--accent-600);padding:12px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(15,80,40,0.06);display:flex;gap:12px;align-items:center;z-index:9999;font-size:0.95rem}
    .crisis-close{ margin-left:auto; background:transparent; border:0; font-size:18px; line-height:1; cursor:pointer; color:var(--accent-600); }
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <a href="index.html" style="text-decoration:none;color:inherit"><strong>MINDWELL</strong></a>
        <div class="small">Sign in to access your personal data</div>
      </div>
      <nav aria-label="Primary">
        <a class="small" href="index.html">Home</a> |
        <a class="small" href="chat.html">Chat</a> |
        <a class="small" href="exercises.html">Exercises</a> |
        <a class="small" href="about.html">About</a>
      </nav>
    </header>

    <div class="grid" role="main">
      <section class="card" aria-labelledby="authTitle">
        <h2 id="authTitle">Sign in / Register</h2>

        <div id="authForms">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="username" />

          <label for="password">Password</label>
          <input id="password" type="password" placeholder="At least 8 characters" autocomplete="current-password" />

          <div class="actions">
            <button id="btnLogin">Sign in</button>
            <button id="btnRegister" class="ghost">Register</button>
            <button id="btnDemo" class="ghost">Demo account</button>
          </div>

          <div id="authMessage" class="msg" role="status" aria-live="polite"></div>
        </div>

        <div id="signedOutActions" style="display:none;margin-top:12px">
          <div class="small muted">Signed out.</div>
        </div>
      </section>

      <aside class="card" id="protectedCard" style="display:none" aria-labelledby="profileTitle">
        <h2 id="profileTitle">Your personal data</h2>

        <div class="small muted">Only visible when signed in.</div>

        <label for="displayName">Display name</label>
        <input id="displayName" type="text" placeholder="Your name" />

        <label for="notes">Private notes</label>
        <textarea id="notes" rows="6" placeholder="Write something..."></textarea>

        <div class="actions" style="margin-top:12px">
          <button id="saveData">Save</button>
          <button id="signOut" class="ghost">Sign out</button>
        </div>

        <div id="dataMsg" class="ok" role="status" aria-live="polite" style="display:none"></div>
      </aside>
    </div>

    <footer>Data is stored locally in your browser. For real authentication integrate Firebase or a backend.</footer>
  </div>

  <!-- Crisis support footer -->
  <div class="crisis-footer" role="contentinfo" aria-live="polite">
    <div>
      If you are in immediate danger or thinking about harming yourself, call local emergency services now. In Cameroon dial <strong>119</strong>.
    </div>
    <button id="crisisClose" class="crisis-close" aria-label="Dismiss crisis support">✕</button>
  </div>

  <script src="motiv.js" defer></script>
  <script>
    // Minimal client-side auth for demo purposes (localStorage). Use a real backend for production.
    const USERS_KEY = 'mh_users_v1';
    const CURRENT_KEY = 'mh_current_user';

    // SHA-256 helper -> hex
    async function sha256hex(str){
      const enc = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    function loadUsers(){
      try { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
      catch(e){ return []; }
    }
    function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }

    function getUserByEmail(email){
      const users = loadUsers();
      return users.find(x => x.email === email);
    }

    async function register(email, password){
      if (!email || !password || password.length < 6) {
        showAuthMsg('Enter valid email and password (min 6 chars).'); return;
      }
      if (getUserByEmail(email)){ showAuthMsg('Account already exists. Please sign in.'); return; }
      const pwHash = await sha256hex(password);
      const users = loadUsers();
      users.push({ email, pwHash });
      saveUsers(users);
      // create empty personal data
      localStorage.setItem(userDataKey(email), JSON.stringify({ name:'', notes:'' }));
      showAuthMsg('Registered. You are signed in.', false);
      setCurrentUser(email);
      renderAuthState();
    }

    async function login(email, password){
      if (!email || !password){ showAuthMsg('Provide email and password.'); return; }
      const user = getUserByEmail(email);
      if (!user){ showAuthMsg('No account found for that email.'); return; }
      const pwHash = await sha256hex(password);
      if (pwHash !== user.pwHash){ showAuthMsg('Incorrect password.'); return; }
      showAuthMsg('Signed in.', false);
      setCurrentUser(email);
      renderAuthState();
    }

    function setCurrentUser(email){
      localStorage.setItem(CURRENT_KEY, email);
    }
    function getCurrentUser(){ return localStorage.getItem(CURRENT_KEY) || null; }
    function signOut(){
      localStorage.removeItem(CURRENT_KEY);
      renderAuthState();
    }

    function userDataKey(email){ return 'mh_userdata_' + encodeURIComponent(email); }

    function loadPersonalData(email){
      try { return JSON.parse(localStorage.getItem(userDataKey(email)) || '{"name":"","notes":""}'); }
      catch(e){ return {name:'',notes:''}; }
    }
    function savePersonalData(email, data){
      localStorage.setItem(userDataKey(email), JSON.stringify(data));
    }

    // UI helpers
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const btnDemo = document.getElementById('btnDemo');
    const authMsg = document.getElementById('authMessage');

    const protectedCard = document.getElementById('protectedCard');
    const displayName = document.getElementById('displayName');
    const notes = document.getElementById('notes');
    const saveDataBtn = document.getElementById('saveData');
    const signOutBtn = document.getElementById('signOut');
    const dataMsg = document.getElementById('dataMsg');

    function showAuthMsg(text, error = true){
      authMsg.textContent = text;
      authMsg.style.color = error ? '#b22' : 'green';
    }

    function renderAuthState(){
      const current = getCurrentUser();
      if (!current){
        protectedCard.style.display = 'none';
        document.getElementById('authForms').style.display = '';
        showAuthMsg('');
        return;
      }
      // load personal data
      const d = loadPersonalData(current);
      displayName.value = d.name || '';
      notes.value = d.notes || '';
      protectedCard.style.display = '';
      document.getElementById('authForms').style.display = 'none';
      showAuthMsg('Signed in as ' + current, false);
    }

    btnRegister.addEventListener('click', async () => {
      await register(emailEl.value.trim().toLowerCase(), passwordEl.value);
    });
    btnLogin.addEventListener('click', async () => {
      await login(emailEl.value.trim().toLowerCase(), passwordEl.value);
    });
    btnDemo.addEventListener('click', async () => {
      // create or use demo account
      const demoEmail = 'demo@mindwell.local';
      const demoPass = 'demo1234';
      if (!getUserByEmail(demoEmail)) {
        const h = await sha256hex(demoPass);
        const u = loadUsers();
        u.push({ email: demoEmail, pwHash: h });
        saveUsers(u);
        localStorage.setItem(userDataKey(demoEmail), JSON.stringify({ name:'Mindwell demo user', notes:'This is a demo note.' }));
      }
      await login(demoEmail, demoPass);
    });

    saveDataBtn.addEventListener('click', () => {
      const cur = getCurrentUser();
      if (!cur) { showAuthMsg('Not signed in.'); return; }
      savePersonalData(cur, { name: displayName.value || '', notes: notes.value || '' });
      dataMsg.style.display = ''; dataMsg.textContent = 'Saved.';
      setTimeout(()=> dataMsg.style.display = 'none', 2000);
    });

    signOutBtn.addEventListener('click', () => { signOut(); showAuthMsg('Signed out.', false); });

    // init
    renderAuthState();

    // Crisis footer behavior
    (function(){
      const KEY = 'mh_crisis_hidden_until';
      const el = document.querySelector('.crisis-footer');
      if (!el) return;
      const close = document.getElementById('crisisClose');
      const hiddenUntil = Number(localStorage.getItem(KEY) || 0);
      if (hiddenUntil > Date.now()) el.style.display = 'none';
      close.addEventListener('click', () => {
        el.style.display = 'none';
        localStorage.setItem(KEY, String(Date.now() + 24*60*60*1000));
      });
    })();

    // stop speech on unload
    window.addEventListener('beforeunload', () => { try{ window.speechSynthesis.cancel(); }catch(e){} });
  </script>
</body>
</html>